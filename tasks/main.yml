---
- name: install build requirements
  become: true
  apt:
    name:
      - libmicrohttpd-dev
      - libjansson-dev
      - libssl-dev
      - libsrtp2-dev
      - libsofia-sip-ua-dev
      - libglib2.0-dev
      - libopus-dev
      - libogg-dev
      - libcurl4-openssl-dev
      - liblua5.3-dev
      - libconfig-dev
      - libnice-dev
      - pkg-config
      - gengetopt
      - libtool
      - automake

- name: clone
  become: false
  git:
    repo: https://github.com/meetecho/janus-gateway
    dest: "{{ janus_home }}"
    update: false
    version: "{{ janus_version }}"
- name: autogen
  become: false
  command: ./autogen.sh
  args:
    chdir: "{{ janus_home }}"
    creates: m4
- name: configure
  become: false
  command: ./configure --prefix=/opt/janus
  args:
    creates: Makefile
    chdir: "{{ janus_home }}"
- name: build
  become: false
  command: make
  args:
    chdir: "{{ janus_home }}"
    creates: janus
- name: janus directory
  become: true
  file:
    path: /opt/janus
    owner: "{{ lookup('env', 'USER') }}"
    group: "{{ lookup('env', 'USER') }}"
    mode: 0755
    state: directory
- name: install
  become: false
  command: make install
  args:
    chdir: "{{ janus_home }}"
    creates: /opt/janus/bin/janus

- name: configuration
  template:
    src: "{{ item }}.j2"
    dest: "/opt/janus/etc/janus/{{ item }}"
  loop:
    - janus.eventhandler.gelfevh.jcfg
    - janus.eventhandler.sampleevh.jcfg
    - janus.jcfg
    - janus.plugin.audiobridge.jcfg
    - janus.plugin.echotest.jcfg
    - janus.plugin.nosip.jcfg
    - janus.plugin.recordplay.jcfg
    - janus.plugin.sip.jcfg
    - janus.plugin.streaming.jcfg
    - janus.plugin.textroom.jcfg
    - janus.plugin.videocall.jcfg
    - janus.plugin.videoroom.jcfg
    - janus.plugin.voicemail.jcfg
    - janus.transport.http.jcfg
    - janus.transport.pfunix.jcfg
